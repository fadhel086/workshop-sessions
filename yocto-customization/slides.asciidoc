= Custom Layers with Yocto
Zilogic Systems <training@zilogic.com>

== Build Your Own Layer and Image

=== Tiny Rootfs

 * As an experiment we can try to build the rootfs, which we had built
   earlier with Zepto, now using yocto. This would involve,

 ** building bash, coreutils & less.

 ** building the ext formatted rootfs

=== Creating Our Own Meta Layer

 * The better practise while working with yocto, is creating your own
   layer to hold your changes.

 * We can run the below command to create a layer called meta-zepto-fs
   in the build folder

[source,shell]
------
$ yocto-layer create zepto-fs
------

 * It prompts for various options which you can leave to default and
   this creates a directory meta-zepto-fs in the current directory.

 * We can find the layer.conf file inside the conf folder of
   meta-zepto-fs.

=== Need for Custom Image

 * As we know that, Yocto expects the list of packages to be built,
   should be provided through a variable IMAGE_INSTALL through a
   recipe or conf file.

 * core-image-minimal.bb was packing-in lots of packages into rootfs

 * for our zepto-fs, we need only three packages bash, coreutils and
   less. It is better to create our own recipe to build rootfs image.

=== Creating Custom Image

 * We can check the recipe of core-image-minimal available in meta
   layer to create our own custom image

[source,shell]
------
$ cat meta/recipes-core/images/core-image-minimal.bb
------

 * It defines IMAGE_INSTALL & inherits core-image class

 * Yocto provides core-image class which can be inherited, to use
   already defined definitions to build rootfs image.

 * When we look on the layer.conf of our layer, we would find that the
   recipes are added to BBFILES from particular folder hierarchy.

------
BBFILES += "${LAYERDIR}/recipes-*/*/*.bb"
------

=== Creating Custom Image

 * Sticking to Yocto's convention, we can create our image recipe
   named core-image-tiny.bb in meta-zepto-fs/recipes-core/images/
   folder

[source,shell]
------
$ mkdir -p meta-zepto-fs/recipes-core/images/
------

=== Knowing Supported Packages

 * The packages that are available in currently added layers, can be
   obtained using

[source,shell]
----------
$ bitbake -s | grep -i coreutils
----------

 * From which we can get the package names for bash, coreutils and
   less.

=== Adding Packages to Recipe

 * In the image recipe file we can define the list of packages to be
   built into the rootfs image.

[source,shell]
------
$ vim meta-zepto-fs/recipes-core/images/core-image-tiny.bb


SUMMARY = "A tiny image just capable of allowing a device to boot."
IMAGE_INSTALL = " bash coreutils less "
inherit core-image
------

=== Handling Layers

 * We can list the layers added and their priority using

[source,shell]
------
$ bitbake-layers show-layers
------

 * We can add a layer to the current build as 

[source,shell]
------
$ bitbake-layers add-layer <path to the layer>
------


 * We can list the recipes based on their layers as 

[source,shell]
------
$ bitbake-layers show-recipes
------
 
=== Adding Our Layer to Yocto

 * The new layer created has distro configuration and the core-image
   recipe.

 * The meta-zepto-fs layer has to be added to the yocto build as

[source,shell]
------
$ bitbake-layers add-layer meta-zepto-fs
------

 * We can find that our layer is added into bblayers.conf

[source,shell]
-----
$ bitbake-layers show-layers
$ cat conf/bblayers.conf
-----

=== High Level Configuration of the Build

 * At-last the configurations for the current build has to be updated
   to the `build/conf/local.conf`

 * For our build we may need to provide two information 
   - target MACHINE for which this build performed and 
   - the DISTRO build policy to which adhered

 * We are going to build the rootfs for the qemu emulated arm target,
   which can be specified as `MACHINE = "qemuarm"`

=== Package Classes and Types

 * By default the distribution is built using opkg packages which is
   openembedded's packaging format, we can override that by declaring
   the `PACKAGE_CLASSES` as `package_deb`

 * If wanted to add any image specific features, like kinds of
   packages(doc, debug, etc) that has to be added to the image, we can
   specify it as shown below in local.conf or core-image-tiny.bb

-----
IMAGE_FEATURES = "doc-pkgs"
-----

=== Building Tiny-FS Image

 * Now we can start building the tiny-fs image by invoking

[source,shell]
--------
$ bitbake core-image-tiny
--------

 * The build should get completed in fewer minutes as it tries to
   reuse state-cache

 * After successful completion of the build the kernel image and
   rootfs images would be available in the
   tmp/deploy/images/qemuarm


=== Checking Our Tiny-FS Image

[source,shell]
--------------
$ ls tmp/deploy/images/qemuarm/
--------------

 * The list of packages in rootfs can be read from manifest file

[source,shell]
---------
$ vim tmp/deploy/images/qemuarm/core-image-tiny-qemuarm.rootfs.manifest
---------

=== Booting the Tiny-FS Image

 * Copy the zImage to shared folder $SHARED and
   core-image-tiny-qemuarm.ext4 as disk.img in $SHARED

 * Now we can boot our new images using qemu arm as shown

[source,shell]
------
$ ./runqemu.sh
------

=== Bare Minimal local.conf

 * The yocto expects the version of the current configuration to be
   provided using CONF_VERSION

[source,shell]
------
S vim conf/local.conf

MACHINE = "qemuarm"
DISTRO = "poky"
CONF_VERSION = "1"
------

 * Below lines can be added to local.conf to modify that to build
   faster

-----
SSTATE_DIR = "/opt/sstate-cache"
BB_NUMBER_THREADS = "3"
-----

=== Adding More Layers

* The recipes provided by default layers of Yocto is less.

* Recipes for BSP is provided by SOC vendors through separate meta
  layer.

* Further packages which are not part of Yocto can be obtained from
  openembedded meta layers.

=== Handling Recipes in Multiple Layers

 * The recipes which are defined in multiple added layers are called
   overlayed recipes.

 * The overlayed recipe in layer, which has higher BB_FILE_PRIORITY
   value, would be considered for build.

 * So provding a higher priority value to local layers would make us
   to build our recipes over upstream recipes.

